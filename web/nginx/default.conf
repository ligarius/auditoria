map $http_host $dev_cache_control {
  default "";
  ~*^(localhost|127\.0\.0\.1|::1)$ "no-store";
}

map $http_host $dev_pragma {
  default "";
  ~*^(localhost|127\.0\.0\.1|::1)$ "no-cache";
}

server {
  listen 80;
  server_name localhost;

  root   /usr/share/nginx/html;
  index  index.html;

  # Evitar respuestas 304 por validación condicional
  etag off;

  # Ruta exacta HTML raíz
  location = / {
    try_files /index.html =404;
    if_modified_since off;
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
  }

  # Cualquier .html directo
  location ~* \.html$ {
    if_modified_since off;
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
  }

  # SPA fallback (rutas internas)
  location / {
    try_files $uri $uri/ /index.html;
    if_modified_since off;
    add_header Cache-Control "no-store" always;
    add_header Pragma "no-cache" always;
  }

  # Assets con hash: cache fuerte e inmutable
  location /assets/ {
    access_log off;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    try_files $uri =404;
  }

  # Otros estáticos (moderado)
  location ~* \.(css|js|woff2?|ttf|eot|svg)$ {
    access_log off;
    expires 7d;
    add_header Cache-Control "public, max-age=604800" always;
    try_files $uri =404;
  }
}
