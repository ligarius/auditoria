{% extends "base.html" %}
{% block title %}Auditoría {{ audit.name }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1>{{ audit.name }}</h1>
        <p class="text-muted">Tipo: {{ audit.audit_type }} | Estado: {{ audit.status }}</p>
    </div>
    {% if user.role in ['admin', 'auditor'] %}
    <form method="post" action="/audits/{{ audit.id }}/status" class="d-flex gap-2">
        <select name="status" class="form-select">
            <option value="planificada" {% if audit.status == 'planificada' %}selected{% endif %}>Planificada</option>
            <option value="en_curso" {% if audit.status == 'en_curso' %}selected{% endif %}>En curso</option>
            <option value="cerrada" {% if audit.status == 'cerrada' %}selected{% endif %}>Cerrada</option>
        </select>
        <button class="btn btn-primary" type="submit">Actualizar</button>
    </form>
    {% endif %}
</div>
<div class="row g-4">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">Checklist</div>
            <div class="card-body">
                <ul class="list-group mb-3">
                    {% for item in audit.checklist_items %}
                        <li class="list-group-item">{{ item.description }}</li>
                    {% else %}
                        <li class="list-group-item">Sin criterios cargados</li>
                    {% endfor %}
                </ul>
                {% if user.role in ['admin', 'auditor'] %}
                <form method="post" action="/audits/{{ audit.id }}/checklist">
                    <div class="mb-2">
                        <label class="form-label">Nuevo criterio</label>
                        <textarea class="form-control" name="description" required></textarea>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" type="submit">Agregar</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">Actividades</div>
            <div class="card-body">
                <ul class="list-group mb-3">
                    {% for activity in audit.activities %}
                        <li class="list-group-item">
                            <strong>{{ activity.activity_date }}</strong> - {{ activity.activity_type }}<br>
                            <small>{{ activity.notes }}</small>
                        </li>
                    {% else %}
                        <li class="list-group-item">Sin actividades registradas</li>
                    {% endfor %}
                </ul>
                {% if user.role in ['admin', 'auditor'] %}
                <form method="post" action="/audits/{{ audit.id }}/activities">
                    <div class="mb-2">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control" name="activity_date" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="activity_type">
                            <option value="visita">Visita</option>
                            <option value="entrevista">Entrevista</option>
                            <option value="documento">Documento revisado</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" name="notes"></textarea>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" type="submit">Registrar</button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">Datos generales</div>
            <div class="card-body">
                <p><strong>Responsable:</strong> {{ audit.responsible.full_name if audit.responsible else 'Sin asignar' }}</p>
                <p><strong>Inicio:</strong> {{ audit.start_date or '-' }}</p>
                <p><strong>Fin:</strong> {{ audit.end_date or '-' }}</p>
                <p><strong>Descripción:</strong><br>{{ audit.description or 'Sin descripción' }}</p>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <h2>Hallazgos y planes de acción</h2>
    {% if user.role in ['admin', 'auditor'] %}
    <div class="card mb-3">
        <div class="card-body">
            <h5>Registrar hallazgo</h5>
            <form method="post" action="/audits/{{ audit.id }}/findings" enctype="multipart/form-data">
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label">Categoría</label>
                        <input class="form-control" type="text" name="category" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Criticidad</label>
                        <select class="form-select" name="severity">
                            <option value="alta">Alta</option>
                            <option value="media">Media</option>
                            <option value="baja">Baja</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Estado</label>
                        <select class="form-select" name="status">
                            <option value="abierto">Abierto</option>
                            <option value="plan_accion">En plan de acción</option>
                            <option value="cerrado">Cerrado</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Evidencia</label>
                        <input class="form-control" type="file" name="evidence">
                    </div>
                </div>
                <div class="mt-2">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-control" name="description" required></textarea>
                </div>
                <button class="btn btn-primary mt-3" type="submit">Guardar hallazgo</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="accordion" id="findingsAccordion">
        {% for finding in audit.findings %}
        <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ finding.id }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ finding.id }}">
                    {{ finding.category }} - {{ finding.severity }} - Estado: {{ finding.status }}
                </button>
            </h2>
            <div id="collapse{{ finding.id }}" class="accordion-collapse collapse" data-bs-parent="#findingsAccordion">
                <div class="accordion-body">
                    <p>{{ finding.description }}</p>
                    {% if finding.evidence_file %}
                        <p><a href="{{ finding.evidence_file }}" target="_blank">Ver evidencia</a></p>
                    {% endif %}
                    {% if user.role in ['admin', 'auditor'] %}
                    <form class="mb-3" method="post" action="/findings/{{ finding.id }}/status">
                        <label class="form-label">Actualizar estado</label>
                        <div class="input-group">
                            <select class="form-select" name="status">
                                <option value="abierto" {% if finding.status == 'abierto' %}selected{% endif %}>Abierto</option>
                                <option value="plan_accion" {% if finding.status == 'plan_accion' %}selected{% endif %}>En plan de acción</option>
                                <option value="cerrado" {% if finding.status == 'cerrado' %}selected{% endif %}>Cerrado</option>
                            </select>
                            <button class="btn btn-outline-primary" type="submit">Actualizar</button>
                        </div>
                    </form>
                    {% endif %}
                    <h5>Planes de acción</h5>
                    <ul class="list-group mb-3">
                        {% for plan in finding.action_plans %}
                            <li class="list-group-item">
                                <strong>{{ plan.description }}</strong><br>
                                Responsable: {{ plan.responsible }} | Compromiso: {{ plan.due_date or '-' }} | Estado: {{ plan.status }}
                                {% if user.role in ['admin', 'auditor', 'client'] %}
                                <form class="mt-2" method="post" action="/action_plans/{{ plan.id }}/status">
                                    <div class="input-group input-group-sm">
                                        <select class="form-select" name="status">
                                            <option value="pendiente" {% if plan.status == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                            <option value="en_progreso" {% if plan.status == 'en_progreso' %}selected{% endif %}>En progreso</option>
                                            <option value="cerrado" {% if plan.status == 'cerrado' %}selected{% endif %}>Cerrado</option>
                                        </select>
                                        <button class="btn btn-outline-success" type="submit">Actualizar</button>
                                    </div>
                                </form>
                                {% endif %}
                            </li>
                        {% else %}
                            <li class="list-group-item">Sin planes registrados</li>
                        {% endfor %}
                    </ul>
                    <div class="card card-body">
                        <h6>Agregar plan de acción</h6>
                        <form method="post" action="/findings/{{ finding.id }}/action_plans">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Responsable</label>
                                    <input class="form-control" type="text" name="responsible" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fecha compromiso</label>
                                    <input class="form-control" type="date" name="due_date">
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="form-label">Acción correctiva</label>
                                <textarea class="form-control" name="description" required></textarea>
                            </div>
                            <button class="btn btn-outline-primary btn-sm mt-2" type="submit">Agregar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
            <p class="text-muted">No hay hallazgos registrados.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}
